<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ¤– Optimus Trading Terminal</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      background: #0a0e17;
      color: #e6edf3;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 800px; margin: 0 auto; }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #21262d;
    }
    .logo { font-size: 24px; font-weight: bold; }
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-active { background: #1a3d2e; color: #3fb950; }
    .status-paper { background: #3d2e1a; color: #d29922; }
    .status-live { background: #3d1a1a; color: #f85149; }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }
    .card {
      background: #161b22;
      border: 1px solid #21262d;
      border-radius: 8px;
      padding: 16px;
    }
    .card.full { grid-column: 1 / -1; }
    .card-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #8b949e;
      margin-bottom: 12px;
    }
    
    .position {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #21262d;
      font-size: 13px;
    }
    .position:last-child { border-bottom: none; }
    .pos-symbol { font-weight: 600; }
    .pos-pnl { color: #3fb950; }
    .pos-pnl.negative { color: #f85149; }
    
    .stat-value { font-size: 28px; font-weight: bold; }
    .stat-label { font-size: 12px; color: #8b949e; }
    .stat-pnl { font-size: 16px; margin-top: 4px; }
    
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab {
      padding: 8px 16px;
      border-radius: 6px;
      background: #21262d;
      color: #8b949e;
      cursor: pointer;
      font-size: 12px;
    }
    .tab.active { background: #0052ff; color: white; }
    
    .decision {
      font-size: 14px;
      padding: 12px;
      background: #0d1117;
      border-radius: 6px;
      margin-top: 8px;
    }
    .decision-hold { border-left: 3px solid #8b949e; }
    .decision-buy { border-left: 3px solid #3fb950; }
    .decision-sell { border-left: 3px solid #f85149; }
    
    .signal-bar {
      height: 8px;
      background: #21262d;
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }
    .signal-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .signal-bull { background: linear-gradient(90deg, #238636, #3fb950); }
    .signal-bear { background: linear-gradient(90deg, #da3633, #f85149); }
    .signal-neutral { background: #8b949e; }
    
    .updated {
      text-align: center;
      font-size: 11px;
      color: #8b949e;
      margin-top: 20px;
    }
    
    .loading { text-align: center; padding: 40px; color: #8b949e; }
    .error { color: #f85149; padding: 20px; text-align: center; }
    
    @media (max-width: 600px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">ðŸ¤– OPTIMUS</div>
      <div id="modeBadge">
        <span class="status-badge status-paper">PAPER</span>
        <span class="status-badge status-active">ACTIVE</span>
      </div>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-mode="paper" onclick="setMode('paper')">Paper Portfolio</div>
      <div class="tab" data-mode="live" onclick="setMode('live')">Live Portfolio</div>
    </div>
    
    <div class="grid">
      <div class="card">
        <div class="card-title">Portfolio Value</div>
        <div class="stat-value" id="totalValue">$0.00</div>
        <div class="stat-pnl" id="totalPnl">â€”</div>
      </div>
      
      <div class="card">
        <div class="card-title">Total Return</div>
        <div class="stat-value" id="totalReturn">0.00%</div>
        <div class="stat-label" id="totalPnlAbs">â€”</div>
      </div>
      
      <div class="card">
        <div class="card-title">Positions</div>
        <div id="positions"><div class="loading">Loading...</div></div>
      </div>
      
      <div class="card">
        <div class="card-title">Signal Bias</div>
        <div class="stat-value" id="signalBias">NEUTRAL</div>
        <div class="stat-label" id="signalConfidence">Confidence: low</div>
        <div class="signal-bar">
          <div id="signalFill" class="signal-fill signal-neutral" style="width: 50%"></div>
        </div>
      </div>
      
      <div class="card full">
        <div class="card-title">Last Decision</div>
        <div id="lastDecision" class="decision decision-hold">
          <strong>HOLD</strong><br><span style="color:#8b949e">Waiting for heartbeat...</span>
        </div>
      </div>
    </div>
    
    <div class="updated">
      Last updated: <span id="updatedAt">â€”</span>
    </div>
  </div>

  <script>
    let currentMode = 'paper';
    
    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.tab').forEach(t => {
        t.classList.toggle('active', t.dataset.mode === mode);
      });
      document.getElementById('modeBadge').innerHTML = mode === 'paper' 
        ? '<span class="status-badge status-paper">PAPER</span> <span class="status-badge status-active">ACTIVE</span>'
        : '<span class="status-badge status-live">LIVE</span> <span class="status-badge status-active">ACTIVE</span>';
      updateDashboard();
    }
    
    // Calls Netlify Function which proxies to Fomolt API
    async function fetchFomolt(endpoint) {
      try {
        // Try redirect path first, then direct function path
        let url = '/api' + endpoint;
        let res = await fetch(url, { cache: 'no-cache' });
        if (res.status === 404) {
          url = '/netlify/functions/api' + endpoint;
          res = await fetch(url, { cache: 'no-cache' });
        }
        if (!res.ok) throw new Error(res.status);
        const json = await res.json();
        return json.success ? json.response : null;
      } catch (e) {
        console.error('Fetch error:', e);
        return null;
      }
    }
    
    function formatUSD(n) {
      return '$' + (n || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    function formatPct(n) {
      if (!n && n !== 0) return 'â€”';
      const sign = n >= 0 ? '+' : '';
      return sign + n.toFixed(2) + '%';
    }
    
    async function updateDashboard() {
      const endpoint = currentMode === 'paper' 
        ? '/agent/paper/dex/portfolio'
        : '/agent/live/dex/portfolio';
      
      const [portfolio, perf, tradesRes] = await Promise.all([
        fetchFomolt(endpoint),
        fetchFomolt(currentMode === 'paper' ? '/agent/paper/dex/performance' : '/agent/live/dex/performance'),
        fetchFomolt('/trades?limit=3')
      ]);
      
      if (!portfolio) {
        document.getElementById('positions').innerHTML = '<div class="error">Unable to load data</div>';
        return;
      }
      
      // Portfolio value
      document.getElementById('totalValue').textContent = formatUSD(portfolio.totalPortfolioValue);
      document.getElementById('totalPnl').textContent = formatUSD(portfolio.totalUnrealizedPnl);
      document.getElementById('totalPnl').className = 'stat-pnl ' + (portfolio.totalUnrealizedPnl >= 0 ? 'pos-pnl' : 'pos-pnl negative');
      
      // Positions
      const positionsHtml = (portfolio.positions || []).map(pos => {
        const pnlVal = pos.unrealizedPnl || 0;
        return `<div class="position"><span class="pos-symbol">${pos.symbol}</span><span>${parseFloat(pos.quantity).toFixed(4)}</span><span class="pos-pnl ${pnlVal >= 0 ? '' : 'negative'}">${formatUSD(pnlVal)}</span></div>`;
      }).join('') || '<div style="color:#8b949e">No positions</div>';
      document.getElementById('positions').innerHTML = positionsHtml;
      
      // Performance
      if (perf) {
        document.getElementById('totalReturn').textContent = formatPct(perf.totalReturnPct);
        document.getElementById('totalReturn').className = 'stat-value ' + (perf.totalReturnPct >= 0 ? 'pos-pnl' : 'pos-pnl negative');
        document.getElementById('totalPnlAbs').textContent = formatUSD(perf.totalPnl);
      }
      
      // Decisions from trades
      if (tradesRes?.response?.trades?.length) {
        const lastTrade = tradesRes.response.trades[0];
        const decision = lastTrade.side.toUpperCase();
        const note = lastTrade.note || `${lastTrade.side} ${lastTrade.symbol}`;
        document.getElementById('lastDecision').innerHTML = `<strong>${decision} ${lastTrade.symbol}</strong><br><span style="color:#8b949e">${note.substring(0, 100)}${note.length > 100 ? '...' : ''}</span>`;
        document.getElementById('lastDecision').className = 'decision decision-' + decision.toLowerCase();
      }
      
      // Updated time
      document.getElementById('updatedAt').textContent = new Date().toLocaleTimeString();
    }
    
    updateDashboard();
    setInterval(updateDashboard, 30000);
  </script>
</body>
</html>
